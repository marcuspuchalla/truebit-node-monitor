# Federation Aggregator for Coolify
#
# This service collects statistics from all TrueBit Monitor nodes and publishes aggregated data.
# It connects to the NATS server via internal Docker network (ws://nats-seed:443).
# External clients connect via wss://f.tru.watch.
#
# Prerequisites:
#   - NATS server must be running (nats/docker-compose.coolify.yml)
#
# What it does:
#   - Subscribes to: truebit.tasks.*, truebit.invoices.*, truebit.heartbeat
#   - Publishes to: truebit.stats.aggregated (every 30 seconds)
#
# Domain: None needed - this is a backend service with no HTTP endpoints

version: '3.8'

services:
  aggregator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: truebit-federation-aggregator
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      # Connect to NATS via internal Docker network (both on same network)
      - NATS_URL=ws://nats-seed:443
      - DB_PATH=/data/aggregator.db
      - PUBLISH_INTERVAL=30000
      - RETENTION_DAYS=30
    volumes:
      - aggregator-data:/data
    networks:
      - coolify
      - truebit-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  aggregator-data:
    driver: local

networks:
  coolify:
    external: true
  truebit-network:
    name: truebit-federation-network
