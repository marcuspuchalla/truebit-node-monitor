# TrueBit Monitor Federation - NATS Server Configuration
# Security-hardened configuration for production deployment
# Version: 1.0

# Server Identity
server_name: "truebit-federation-seed"

# Network Configuration
host: "0.0.0.0"
port: 4222

# HTTP Monitoring (internal only, DO NOT expose publicly)
http_port: 8222

# TLS Configuration (MANDATORY for production)
tls {
  cert_file: "/etc/nats/certs/server-cert.pem"
  key_file: "/etc/nats/certs/server-key.pem"
  ca_file: "/etc/nats/certs/ca-cert.pem"

  # Verify client certificates
  verify: true

  # Require TLS for all connections
  timeout: 5
}

# JWT Authentication
authorization {
  # Use decentralized JWT authentication
  # Users generate their own JWTs signed by trusted operator
  users = [
    {
      # Default user for monitoring (read-only)
      user: "monitor"
      password: "$2a$11$..." # bcrypt hash - CHANGE IN PRODUCTION
      permissions: {
        publish: {
          allow: ["truebit.>"]
        }
        subscribe: {
          allow: ["truebit.>"]
        }
      }
    }
  ]
}

# Leaf Node Configuration
# Allows federation participants to connect as leaf nodes
leafnodes {
  # Listen for leaf node connections
  listen: "0.0.0.0:7422"

  # TLS for leaf connections
  tls {
    cert_file: "/etc/nats/certs/server-cert.pem"
    key_file: "/etc/nats/certs/server-key.pem"
    ca_file: "/etc/nats/certs/ca-cert.pem"
    verify: true
    timeout: 5
  }

  # Authentication for leaf nodes
  authorization {
    user: "leafnode"
    password: "$2a$11$..." # bcrypt hash - CHANGE IN PRODUCTION
    timeout: 5
  }
}

# Limits and Performance
limits {
  # Maximum payload size (1MB)
  max_payload: 1048576

  # Maximum connections per IP (prevent resource exhaustion)
  max_connections: 100

  # Maximum subscriptions per connection
  max_subscriptions: 100

  # Slow consumer settings (prevent one slow client from blocking others)
  max_pending_size: 10485760  # 10MB
}

# Logging
log_file: "/var/log/nats/nats-server.log"
log_size_limit: 104857600  # 100MB
logtime: true
debug: false
trace: false

# Monitoring and Health
# Access http://localhost:8222/varz for server statistics
# Access http://localhost:8222/healthz for health check
# IMPORTANT: Only expose monitoring port internally, never publicly

# Subject Namespace for TrueBit Federation
# All federation messages use the "truebit.*" namespace:
# - truebit.tasks.received
# - truebit.tasks.completed
# - truebit.heartbeat
# - truebit.stats.*

# Security Notes:
# 1. NEVER disable TLS in production
# 2. Change default passwords before deployment
# 3. Use strong, unique passwords (bcrypt hashed)
# 4. Restrict monitoring port (8222) to internal network only
# 5. Use firewall rules to limit connections
# 6. Rotate TLS certificates regularly (every 90 days recommended)
# 7. Monitor logs for suspicious activity
# 8. Keep NATS server updated to latest version
