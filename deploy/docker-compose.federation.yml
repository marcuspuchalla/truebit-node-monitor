# =============================================================================
# TrueBit Federation NATS Server
# =============================================================================
#
# Standard NATS Ports:
#   4222 - Client connections (TCP)
#   8222 - HTTP monitoring
#   443  - WebSocket (no TLS internally, Traefik handles TLS)
#
# External access:
#   wss://f.tru.watch:9086 -> Traefik (TLS on port 9086) -> container:443
#
# Traefik Configuration Required:
#   Add to Traefik proxy command section in Coolify:
#     - '--entrypoints.natsws.address=:9086'
#   Add to Traefik ports:
#     - '9086:9086'
#
# NOTE: We use a dedicated port (9086) with HTTP router for WebSocket.
# This ensures proper WebSocket upgrade handling and avoids HTTP/2 ALPN
# negotiation issues with Firefox and iOS Safari.
# =============================================================================

services:
  nats-seed:
    image: nats:2.10-alpine
    container_name: truebit-federation-nats
    restart: unless-stopped

    entrypoint:
      - /bin/sh
      - '-c'
    command:
      - |
        cat > /tmp/nats.conf << 'EOF'
        port: 4222
        http_port: 8222
        websocket {
          port: 443
          no_tls: true
        }
        jetstream {
          store_dir: /data
        }
        max_payload: 1048576
        EOF
        exec nats-server -c /tmp/nats.conf

    volumes:
      - nats-data:/data

    networks:
      - coolify
      - truebit-network

    labels:
      - traefik.enable=true
      - traefik.docker.network=coolify

      # WebSocket router (wss://f.tru.watch:9086)
      # Uses dedicated entrypoint to avoid HTTP/2 ALPN issues
      - traefik.http.routers.truebit-nats-ws.rule=Host(`f.tru.watch`)
      - traefik.http.routers.truebit-nats-ws.entrypoints=natsws
      - traefik.http.routers.truebit-nats-ws.tls=true
      - traefik.http.routers.truebit-nats-ws.tls.certresolver=letsencrypt
      - traefik.http.routers.truebit-nats-ws.service=truebit-nats-ws
      - traefik.http.services.truebit-nats-ws.loadbalancer.server.port=443

    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8222/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  nats-data:
    driver: local

networks:
  coolify:
    external: true
  truebit-network:
    name: truebit-federation-network
