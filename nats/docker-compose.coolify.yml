# =============================================================================
# TrueBit Federation NATS Server
# =============================================================================
#
# External: wss://f.tru.watch (standard HTTPS port 443)
# Internal: ws://nats-seed:443 via coolify network
#
# IMPORTANT: Set these environment variables in Coolify!
#   NATS_AGGREGATOR_PASSWORD - Secret password for aggregator (keep secure!)
#   NATS_MONITOR_PASSWORD    - Password for monitor nodes
# Generate with: openssl rand -base64 32
#
# No Traefik configuration changes required - uses standard HTTPS entrypoint.
# =============================================================================

services:
  nats-seed:
    image: nats:2.10-alpine
    container_name: truebit-federation-nats
    restart: unless-stopped

    environment:
      # IMPORTANT: Set these in Coolify environment variables!
      - NATS_AGGREGATOR_PASSWORD=${NATS_AGGREGATOR_PASSWORD:?NATS_AGGREGATOR_PASSWORD is required}
      - NATS_MONITOR_PASSWORD=${NATS_MONITOR_PASSWORD:?NATS_MONITOR_PASSWORD is required}

    entrypoint:
      - /bin/sh
      - '-c'
    command:
      - |
        cat > /tmp/nats.conf << EOF
        port: 4222
        # Monitoring only on localhost for security
        http_port: 8222
        http: "127.0.0.1:8222"

        # Authentication & Authorization
        authorization {
          users = [
            # Aggregator: Full permissions (internal service only)
            {
              user: aggregator
              password: "${NATS_AGGREGATOR_PASSWORD}"
              permissions: {
                publish: ">"
                subscribe: ">"
              }
            }
            # Monitor: Limited permissions (external clients)
            {
              user: monitor
              password: "${NATS_MONITOR_PASSWORD}"
              permissions: {
                publish: ["truebit.tasks.>", "truebit.invoices.>", "truebit.heartbeat", "truebit.nodes.>"]
                subscribe: ["truebit.stats.aggregated", "truebit.>"]
              }
            }
          ]
        }

        websocket {
          port: 443
          no_tls: true
        }
        jetstream {
          store_dir: /data
        }
        max_payload: 1048576
        EOF
        exec nats-server -c /tmp/nats.conf

    volumes:
      - nats-data:/data

    networks:
      - coolify
      - truebit-network

    # Explicitly expose WebSocket port for Traefik
    expose:
      - "443"

    labels:
      - traefik.enable=true
      - traefik.docker.network=coolify

      # WebSocket router (wss://f.tru.watch)
      - traefik.http.routers.truebit-nats-ws.rule=Host(`f.tru.watch`)
      - traefik.http.routers.truebit-nats-ws.entrypoints=https
      - traefik.http.routers.truebit-nats-ws.tls=true
      - traefik.http.routers.truebit-nats-ws.tls.certresolver=letsencrypt
      - traefik.http.routers.truebit-nats-ws.service=truebit-nats-ws

      # Backend service configuration
      # Use HTTP scheme since NATS uses no_tls (Traefik handles TLS termination)
      - traefik.http.services.truebit-nats-ws.loadbalancer.server.port=443
      - traefik.http.services.truebit-nats-ws.loadbalancer.server.scheme=http

    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:8222/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  nats-data:
    driver: local

networks:
  coolify:
    external: true
  truebit-network:
    name: truebit-federation-network
