# NATS Server Configuration for TrueBit Federation
# This configuration enables WebSocket connections for browser-based monitors

# Server identification
server_name: truebit-federation

# Client connections
port: 4222

# HTTP monitoring endpoint - bind to localhost only for security
# External access should be blocked by firewall
http_port: 8222
http: "127.0.0.1:8222"

# ===== AUTHENTICATION & AUTHORIZATION =====
# Two-tier access:
#   1. aggregator - internal service with full permissions
#   2. monitor - external monitors with limited permissions (publish tasks/heartbeats, subscribe to stats)
authorization {
    users = [
        # Aggregator: Full permissions (internal service only)
        # IMPORTANT: Keep this token secret!
        {
            user: aggregator
            password: $NATS_AGGREGATOR_PASSWORD
            permissions: {
                publish: ">"
                subscribe: ">"
            }
        }
        # Monitor: Limited permissions (external clients)
        # This token is distributed to monitor nodes
        {
            user: monitor
            password: $NATS_MONITOR_PASSWORD
            permissions: {
                # Can publish task events, heartbeats, and node status
                publish: ["truebit.tasks.>", "truebit.invoices.>", "truebit.heartbeat", "truebit.nodes.>"]
                # Can subscribe to aggregated stats and their own wildcard
                subscribe: ["truebit.stats.aggregated", "truebit.>"]
            }
        }
    ]
}

# WebSocket configuration (required for browser connections)
websocket {
    # WebSocket port - use 443 for TLS or 80 for plain
    port: 443

    # Enable TLS (required for production)
    # Uncomment and configure for production use:
    # tls {
    #     cert_file: "/etc/nats/certs/server.crt"
    #     key_file: "/etc/nats/certs/server.key"
    # }

    # For development/testing without TLS:
    no_tls: true
}

# Logging
debug: false
trace: false
logtime: true

# Connection limits
max_connections: 10000
max_payload: 1MB

# Ping/Pong settings for connection health
ping_interval: 30s
ping_max: 3

# Write deadline for slow consumers
write_deadline: 10s
